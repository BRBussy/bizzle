steps:
  - name: gcr.io/cloud-builders/gcloud
    id: 'decrypt config files'
    args:
      - kms
      - decrypt --ciphertext-file=configs/auth/config.toml.enc --plaintext-file=configs/auth/config.toml --location=global --keyring=bizzle --key=cryptographer
      - decrypt --ciphertext-file=configs/role/config.toml.enc --plaintext-file=configs/role/config.toml --location=global --keyring=bizzle --key=cryptographer
      - decrypt --ciphertext-file=configs/user/config.toml.enc --plaintext-file=configs/user/config.toml --location=global --keyring=bizzle --key=cryptographer
      - decrypt --ciphertext-file=configs/budget/config.toml.enc --plaintext-file=configs/budget/config.toml --location=global --keyring=bizzle --key=cryptographer
    waitFor: ['-']

  #
  # -------- auth service ------
  #
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build auth image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker build -f build/package/auth/Dockerfile -t gcr.io/$PROJECT_ID/auth .
        docker push gcr.io/$PROJECT_ID/auth
    waitFor: ['decrypt config files']

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy auth'
    args: ['beta', 'run', 'deploy', 'auth', '--image', 'gcr.io/$PROJECT_ID/auth', '--region', 'us-central1','--platform', 'managed', '--quiet']
    waitFor: ['build auth image']

  #
  # -------- role service ------
  #
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build role image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker build -f build/package/role/Dockerfile -t gcr.io/$PROJECT_ID/role .
        docker push gcr.io/$PROJECT_ID/role
    waitFor: ['decrypt config files']

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy role'
    args: ['beta', 'run', 'deploy', 'role', '--image', 'gcr.io/$PROJECT_ID/role', '--region', 'us-central1','--platform', 'managed', '--quiet']
    waitFor: ['build role image']

  #
  # -------- user service ------
  #
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build user image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker build -f build/package/user/Dockerfile -t gcr.io/$PROJECT_ID/user .
        docker push gcr.io/$PROJECT_ID/user
    waitFor: ['decrypt config files']

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy user'
    args: ['beta', 'run', 'deploy', 'user', '--image', 'gcr.io/$PROJECT_ID/user', '--region', 'us-central1','--platform', 'managed', '--quiet']
    waitFor: ['build user image']

  #
  # -------- budget service ------
  #
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build budget image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker build -f build/package/budget/Dockerfile -t gcr.io/$PROJECT_ID/budget .
        docker push gcr.io/$PROJECT_ID/budget
    waitFor: ['decrypt config files']

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy budget'
    args: ['beta', 'run', 'deploy', 'budget', '--image', 'gcr.io/$PROJECT_ID/budget', '--region', 'us-central1','--platform', 'managed', '--quiet']
    waitFor: ['build budget image']

timeout: 1200s